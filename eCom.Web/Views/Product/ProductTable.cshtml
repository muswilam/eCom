@model eCom.Web.ViewModels.ProductSearchViewModel

@{
    ViewBag.Title = "ProductTable";
}

<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
<script src="http://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>

<div>
    <form>
        <div class="input-group mt-3 mb-3">
            <input id="searchTxt" name="Search" class="form-control mr-1" value="@Model.SearchTerm" placeholder="Search..." />
            <div class="input-group-append">
                <button type="button" id="searchBtn" class="btn btn-primary">Search</button>
                <button type="button" id="newBtn" class="btn btn-primary">New</button>
            </div>
        </div>
    </form>
</div>

<div>
    <table id="productsTable" class="table table-striped">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Products != null && Model.Products.Count > 0)
            {
                foreach (var product in Model.Products)
                {
                    <tr>
                        <td>@product.Name</td>
                        <td>
                            @if (product.Category != null)
                            {
                                <text> @product.Category.Name </text>
                            }
                            else
                            {
                                <text> - </text>
                            }
                        </td>
                        <td>@product.Price</td>
                        <td>
                            <button class="editBtn" data-id="@product.Id">Edit</button>
                            <button class="deleteBtn" data-id="@product.Id" data-name="@product.Name">Delete</button>
                            <button class="addToCart" data-id="@product.Id">Add To Cart</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="4" class="text-danger">No products found.</td></tr>}
        </tbody>

    </table>
    <div>
        @*@if (Model.PageNo != 1)
        {
            <button class="pgaeButtons" data-pageno="@(Model.PageNo - 1)">Previous</button>
        }
        <button class="pgaeButtons" data-pageno="@(Model.PageNo + 1)">Next</button>*@
    </div>
</div>

<script>

    $("#productsTable").DataTable();

    $(".pgaeButtons").click(function () {
        $.ajax({
            url: '/Product/ProductTable',
            data: {
                pageNo: $(this).attr("data-pageno")
            },
        })
        .done(function (result) {
            focusTable();
            $("#tableContainer").html(result);
        })
        .fail(function () {
            alert("Fail");
        })
    });

    $("#searchBtn").click(function () {
        debugger;
        var searchValue = $("#searchTxt").val();
        $.ajax({
            url: '/Product/ProductTable',
            data: {
                search: searchValue
            },
            type: 'Get',
        })
        .done(function (result) {
            $("#tableContainer").html(result);
            debugger;
        })
        .fail(function () {
            alert("Fail");
        })
        debugger;
    });

    $("#newBtn").click(function () {
        $.ajax({
            url: '/Product/Create',
        })
        .done(function (result) {
            $("#actionContainer").html(result);
            focusAction()
        })
        .fail(function () {
            alert("Fail");
        })
    });

    $(".editBtn").click(function () {
        var id = $(this).attr("data-id");
        $.ajax({
            url: '/Product/Edit/' + id,
        })
        .done(function (result) {
            $("#actionContainer").html(result);
            focusAction();
        })
        .fail(function () {
            alert("Fail");
        })
    })

    $(".deleteBtn").click(function () {
        var id = $(this).attr("data-id");
        var name = $(this).attr("data-name");
        swal({
            title: "Confirm!",
            text: "Are you sure. you wanna delete " + name + " ?",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
        .then(function (willDelete) {
            if (willDelete) {

                $.ajax({
                    url: '/Product/Delete/' + id,
                    type: 'Post'
                })
                 .done(function (result) {

                     swal(name + " deleted successfuly.", {
                         icon: "success",
                     });

                     $("#tableContainer").html(result);
                 })
                 .fail(function () {
                     alert("Fail");
                 })
            }
        });
    });

    var products = [];

    $(".addToCart").click(function () {
        var productId = $(this).attr("data-id");
        products.push(productId);

        $.cookie('cartProduct', products.join('-')); // { path: '/'} to allow cookie in others controllers

        alert("Product added to cart.");

    });

    function focusAction() {
        $('html, body').animate({
            scrollTop: $("#actionContainer").offset().top - 100
        }, 700);
    }

    function focusTable() {
        $('html, body').animate({
            scrollTop: $("#tableContainer").offset().top - 100
        }, 700);
    }
</script>